# =============================================================================
# PostgreSQL Configuration - Oracle Cloud Free Tier Optimized
# 4GB RAM Total System - 1.2GB Allocated to PostgreSQL
# Tuned for ARM Ampere A1 (Oracle Cloud) with SSD storage
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------
# Limita connessioni per risparmiare RAM (default 100 troppi per 4GB)
max_connections = 20
superuser_reserved_connections = 2

# Listen su tutte le interfacce (Docker networking)
listen_addresses = '*'
port = 5432

# -----------------------------------------------------------------------------
# MEMORY SETTINGS - Ottimizzati per 1.2GB allocati
# -----------------------------------------------------------------------------
# Shared buffers: 25% della RAM allocata a PG (300MB → arrotondato a 256MB)
shared_buffers = 256MB

# Effective cache size: 75% della RAM totale sistema (3GB)
# Indicatore per il query planner, non memoria allocata
effective_cache_size = 768MB

# Work memory: per operazioni di sort/hash per connection
# 20 connessioni * 16MB = max 320MB per query parallele
work_mem = 16MB

# Maintenance work memory: per vacuum, index, alter table
maintenance_work_mem = 64MB

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOGGING (WAL) - Bilanciato durability/performance
# -----------------------------------------------------------------------------
wal_buffers = 16MB
max_wal_size = 1GB
min_wal_size = 512MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min

# Syncronization: off per performance, risk accepted per demo/development
# Per produzione con dati critici, usare 'on' o 'fsync'
# s_synchronous_commit = off  # Uncomment solo se performance > durability

# -----------------------------------------------------------------------------
# QUERY PLANNER - Ottimizzazioni per SSD
# -----------------------------------------------------------------------------
# SSD random access è quasi veloce come sequential
random_page_cost = 1.1
effective_io_concurrency = 200

default_statistics_target = 100

# Abilita parallel query (limitato su 1 CPU)
max_parallel_workers_per_gather = 1
max_parallel_workers = 2
max_worker_processes = 2

# -----------------------------------------------------------------------------
# AUTOVACUUM - Mantieni tabelle healthy
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 1
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# LOGGING - Minimale per risparmiare I/O
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Log solo errori e query lente (>1s)
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000

# -----------------------------------------------------------------------------
# LOCALE & ENCODING
# -----------------------------------------------------------------------------
client_encoding = utf8
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# DOCKER/CONTAINER SPECIFIC
# -----------------------------------------------------------------------------
# Non usare huge pages in container
huge_pages = off

# Limita shared memory per container
dynamic_shared_memory_type = posix

# Faster shutdown per container restart
shutdown_timeout = '30s'

# -----------------------------------------------------------------------------
# EXTENSIONS
# -----------------------------------------------------------------------------
# uuid-ossp per UUID generation
# pgcrypto per hashing
# pg_trgm per text search
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements config
pg_stat_statements.max = 1000
pg_stat_statements.track = all
