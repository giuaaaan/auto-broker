# =============================================================================
# Auto-Broker Enterprise Deployment - Oracle Cloud Free Tier
# 4GB RAM / 1 CPU ARM Ampere A1 Optimized
# Zero-Waste Architecture - Every MB Counts
# =============================================================================
# Resource Allocation:
#   nginx:    64MB   (Reverse proxy + static assets)
#   postgres: 1.2GB  (Tuned for ARM + SSD)
#   redis:    256MB  (Maxmemory 256MB + LRU eviction)
#   api:      768MB  (FastAPI + uvicorn 2 workers)
#   system:   ~300MB (OS overhead)
#   free:     ~1.4GB (Buffer per spike/peak)
# =============================================================================

version: '3.8'

services:
  # ============================================================================
  # NGINX - Reverse Proxy & Static Assets (64MB)
  # ============================================================================
  nginx:
    image: nginx:alpine-slim
    container_name: autobroker-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/oracle-nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
    networks:
      - autobroker-network
    depends_on:
      api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
        reservations:
          cpus: '0.1'
          memory: 32M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # POSTGRESQL - Database (1.2GB)
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: autobroker-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-autobroker}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-autobroker_secure_2024}
      POSTGRES_DB: ${DB_NAME:-autobroker}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgresql.oracle.conf:/etc/postgresql/postgresql.conf:ro
      - postgres_logs:/var/log/postgresql
    command: >
      postgres 
      -c config_file=/etc/postgresql/postgresql.conf
      -c log_destination=stderr
    networks:
      - autobroker-network
    ports:
      - "127.0.0.1:5432:5432"  # Solo localhost per sicurezza
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1200M
        reservations:
          cpus: '0.25'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-autobroker} -d ${DB_NAME:-autobroker}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # REDIS - Cache & Session Store (256MB)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: autobroker-redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --save ""
      --loglevel warning
    volumes:
      - redis_data:/data
    networks:
      - autobroker-network
    ports:
      - "127.0.0.1:6379:6379"  # Solo localhost
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ============================================================================
  # API - FastAPI Application (768MB)
  # ============================================================================
  api:
    build:
      context: ./api
      dockerfile: Dockerfile.optimized
    container_name: autobroker-api
    restart: unless-stopped
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://${DB_USER:-autobroker}:${DB_PASSWORD:-autobroker_secure_2024}@postgres:5432/${DB_NAME:-autobroker}
      DATABASE_POOL_SIZE: 5
      DATABASE_MAX_OVERFLOW: 10
      
      # Redis
      REDIS_URL: redis://redis:6379/0
      
      # AI Services
      HUME_API_KEY: ${HUME_API_KEY}
      HUME_SECRET_KEY: ${HUME_SECRET_KEY}
      INSIGHTO_API_KEY: ${INSIGHTO_API_KEY}
      
      # Security
      JWT_SECRET: ${JWT_SECRET:-change_this_in_production_32_chars_min}
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_HOURS: 24
      
      # Environment
      ENV: production
      LOG_LEVEL: INFO
      ENABLE_METRICS: "true"
      
      # Performance
      UVICORN_WORKERS: 2
      UVICORN_LOOP: uvloop
    volumes:
      - ./api:/app:ro  # Solo read-only in produzione
      - api_logs:/app/logs
    networks:
      - autobroker-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 384M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ============================================================================
  # OLLAMA - Local AI (1.5GB) - DISABILITATO DI DEFAULT
  # Usare solo con: docker-compose --profile local-ai up
  # In produzione usare Hume AI (cloud, zero RAM locale)
  # ============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: autobroker-ollama
    restart: unless-stopped
    profiles:
      - "local-ai"
    environment:
      OLLAMA_ORIGINS: "*"
      OLLAMA_HOST: "0.0.0.0:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - autobroker-network
    ports:
      - "127.0.0.1:11434:11434"  # Solo localhost
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1500M
        reservations:
          cpus: '0.25'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # NODE EXPORTER - Monitoring (32MB) - OPZIONALE
  # Rimuovere commento se c'Ã¨ spazio disponibile
  # ============================================================================
  # node-exporter:
  #   image: prom/node-exporter:latest
  #   container_name: autobroker-node-exporter
  #   restart: unless-stopped
  #   command:
  #     - '--path.procfs=/host/proc'
  #     - '--path.sysfs=/host/sys'
  #     - '--path.rootfs=/rootfs'
  #     - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  #   volumes:
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/rootfs:ro
  #   networks:
  #     - autobroker-network
  #   ports:
  #     - "127.0.0.1:9100:9100"
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.05'
  #         memory: 32M
  #   profiles:
  #     - monitoring

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  autobroker-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    driver: local
  postgres_logs:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local
  api_logs:
    driver: local
  nginx_cache:
    driver: local
